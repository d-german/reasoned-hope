<!-- Writerside Algolia Search Integration for Reasoned Hope -->
<style>
    /* ───────────────────────────────────────────────────────────────
       1. REMOVE Writerside "powered-by" FOOTER
       ────────────────────────────────────────────────────────────── */
    .app__footer {
        display: none !important;
    }

    /* ───────────────────────────────────────────────────────────────
       2. HIDE quick-search header & any Advanced-search button
       ────────────────────────────────────────────────────────────── */
    .quick-search__results-header,
    [data-test="full-search-button"],
    .quick-search__advanced-link,
    .DocSearch-SeeAllResults,
    button[aria-label="See all results"] {
        display: none !important;
    }

    /* ───────────────────────────────────────────────────────────────
       3. STYLE the placeholder text
       ────────────────────────────────────────────────────────────── */
    [data-test-id="search-input"]::placeholder {
        color: #888 !important;
        opacity: 1 !important;
    }

    /* ───────────────────────────────────────────────────────────────
       4. HIDE search-copyright div
       ────────────────────────────────────────────────────────────── */
    [data-test="search-copyright"],
    .search-copyright,
    .DocSearch-Logo,
    .DocSearch-PoweredBy {
        display: none !important;
    }

    /* ───────────────────────────────────────────────────────────────
       5. HIDE "Last modified" edit info
       ────────────────────────────────────────────────────────────── */
    .sub-title__edit-info {
        display: none !important;
    }
</style>

<script>
    /* Search integration for Reasoned Hope documentation with facet filter fix */
    (function () {
        console.log('🔍 Initializing Algolia facet filter patch...');

        /* ───── Comprehensive Algolia request patching ───── */

        // Patch fetch
        if (window.fetch) {
            const originalFetch = window.fetch;
            window.fetch = function(input, init) {
                const url = typeof input === 'string' ? input : input?.url;

                if (url && url.includes('algolia.net')) {
                    console.log('🔍 Intercepted Algolia fetch request:', url);

                    if (init?.body) {
                        try {
                            let body = init.body;
                            let modified = false;

                            // Handle JSON body
                            if (typeof body === 'string' && body.trim().startsWith('{')) {
                                const data = JSON.parse(body);
                                if (data.facetFilters && data.facetFilters.length > 0) {
                                    console.log('🔧 Removing facet filters from JSON body:', data.facetFilters);
                                    data.facetFilters = [];
                                    init.body = JSON.stringify(data);
                                    modified = true;
                                }
                            }

                            // Handle form-encoded body
                            if (typeof body === 'string' && body.includes('facetFilters=')) {
                                console.log('🔧 Removing facet filters from form body');
                                init.body = body.replace(/facetFilters=%5B[^&]*%5D/g, 'facetFilters=%5B%5D');
                                modified = true;
                            }

                            if (modified) {
                                console.log('✅ Modified Algolia request body');
                            }
                        } catch (e) {
                            console.warn('❌ Failed to modify Algolia request:', e);
                        }
                    }
                }

                return originalFetch.apply(this, arguments);
            };
            console.log('✅ Fetch patched');
        }

        // Patch XMLHttpRequest
        if (window.XMLHttpRequest) {
            const OriginalXHR = window.XMLHttpRequest;
            const originalOpen = OriginalXHR.prototype.open;
            const originalSend = OriginalXHR.prototype.send;

            let currentUrl = '';

            OriginalXHR.prototype.open = function(method, url, ...args) {
                currentUrl = url || '';
                return originalOpen.apply(this, [method, url, ...args]);
            };

            OriginalXHR.prototype.send = function(body) {
                if (currentUrl.includes('algolia.net') && body) {
                    console.log('🔍 Intercepted Algolia XHR request:', currentUrl);

                    try {
                        let modifiedBody = body;

                        if (typeof body === 'string') {
                            if (body.includes('facetFilters')) {
                                console.log('🔧 Removing facet filters from XHR body');
                                modifiedBody = body.replace(/facetFilters=%5B[^&]*%5D/g, 'facetFilters=%5B%5D');
                                modifiedBody = modifiedBody.replace(/"facetFilters":\[[^\]]*\]/g, '"facetFilters":[]');
                                console.log('✅ Modified XHR request body');
                            }
                        }

                        return originalSend.call(this, modifiedBody);
                    } catch (e) {
                        console.warn('❌ Failed to modify XHR request:', e);
                    }
                }

                return originalSend.apply(this, arguments);
            };
            console.log('✅ XMLHttpRequest patched');
        }

        /* ───── config ───── */
        const INPUT_SEL = '[data-test-id="search-input"]';
        const NEW_PLACEHOLDER = 'Search documentation...';
        const BAD_SUFFIX = /\s*:\s*undefined\s*$/;

        /* ───── helpers ───── */
        function tidyTitle(el) {
            if (el && BAD_SUFFIX.test(el.textContent))
                el.textContent = el.textContent.replace(BAD_SUFFIX, '');
        }

        /** remove/replace placeholder + keep it that way */
        function patchInput(inp) {
            if (!inp) return;

            // remove attribute and set property
            inp.removeAttribute('placeholder');
            inp.placeholder = NEW_PLACEHOLDER;

            // if Writerside rewrites it later, patch again
            new MutationObserver(muts =>
                muts.forEach(m => {
                    if (m.attributeName === 'placeholder' &&
                        inp.placeholder !== NEW_PLACEHOLDER) {
                        inp.removeAttribute('placeholder');
                        inp.placeholder = NEW_PLACEHOLDER;
                    }
                })
            ).observe(inp, {attributes: true, attributeFilter: ['placeholder']});
        }

        /* ───── initialise once the DOM is ready ───── */
        function init() {
            /* clean any titles already rendered */
            document.querySelectorAll('.quick-search__title').forEach(tidyTitle);

            /* patch existing input(s) */
            document.querySelectorAll(INPUT_SEL).forEach(patchInput);

            /* observe future DOM changes */
            new MutationObserver(muts =>
                muts.forEach(m =>
                    m.addedNodes.forEach(node => {
                        if (node.nodeType === 1) { // Element node
                            node.querySelectorAll?.('.quick-search__title').forEach(tidyTitle);
                            if (node.matches?.('.quick-search__title')) tidyTitle(node);

                            node.querySelectorAll?.(INPUT_SEL).forEach(patchInput);
                            if (node.matches?.(INPUT_SEL)) patchInput(node);
                        }
                    })
                )
            ).observe(document.body, {childList: true, subtree: true});

            console.log('🔍 Reasoned Hope search integration loaded successfully');
        }

        document.readyState === 'loading'
            ? document.addEventListener('DOMContentLoaded', init)
            : init();
    })();
</script>
